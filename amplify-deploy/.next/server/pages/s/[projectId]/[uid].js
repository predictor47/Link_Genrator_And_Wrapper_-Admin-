(()=>{var e={};e.id=605,e.ids=[605,888,660],e.modules={5277:(e,t,s)=>{"use strict";s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{config:()=>x,default:()=>p,getServerSideProps:()=>g,getStaticPaths:()=>m,getStaticProps:()=>h,reportWebVitals:()=>f,routeModule:()=>j,unstable_getServerProps:()=>w,unstable_getServerSideProps:()=>S,unstable_getStaticParams:()=>b,unstable_getStaticPaths:()=>y,unstable_getStaticProps:()=>v});var i=s(7093),a=s(5244),n=s(1323),o=s(2899),l=s.n(o),c=s(3893),d=s(601),u=e([d]);d=(u.then?(await u)():u)[0];let p=(0,n.l)(d,"default"),h=(0,n.l)(d,"getStaticProps"),m=(0,n.l)(d,"getStaticPaths"),g=(0,n.l)(d,"getServerSideProps"),x=(0,n.l)(d,"config"),f=(0,n.l)(d,"reportWebVitals"),v=(0,n.l)(d,"unstable_getStaticProps"),y=(0,n.l)(d,"unstable_getStaticPaths"),b=(0,n.l)(d,"unstable_getStaticParams"),w=(0,n.l)(d,"unstable_getServerProps"),S=(0,n.l)(d,"unstable_getServerSideProps"),j=new i.PagesRouteModule({definition:{kind:a.x.PAGES,page:"/s/[projectId]/[uid]",pathname:"/s/[projectId]/[uid]",bundlePath:"",filename:""},components:{App:c.default,Document:l()},userland:d});r()}catch(e){r(e)}})},8925:(e,t,s)=>{"use strict";s.d(t,{_:()=>i});let r=require("@prisma/client"),i=global.prisma||new r.PrismaClient({log:["error"]})},3893:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>n});var r=s(997),i=s(968),a=s.n(i);function n({Component:e,pageProps:t}){return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(a(),{children:[r.jsx("title",{children:"Survey Link Wrapper"}),r.jsx("meta",{name:"description",content:"Wrapping third-party survey links with a validation layer"}),r.jsx("link",{rel:"icon",href:"/favicon.ico"}),r.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1"})]}),r.jsx(e,{...t})]})}s(108)},601:(e,t,s)=>{"use strict";s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{default:()=>p,getServerSideProps:()=>h});var i=s(997),a=s(6689),n=s(1163),o=s(9648),l=s(2534),c=s.n(l),d=s(8925),u=e([o]);o=(u.then?(await u)():u)[0];let m=()=>({timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,fingerprint:window.navigator.userAgent,screenSize:{width:window.screen.width,height:window.screen.height},colorDepth:window.screen.colorDepth,language:window.navigator.language,hasLocalStorage:!!window.localStorage,hasSessionStorage:!!window.sessionStorage});function p({projectId:e,uid:t,questions:s,isValid:r,errorMessage:l}){let d=(0,n.useRouter)(),[u,p]=(0,a.useState)(null),[h,g]=(0,a.useState)([]),[x,f]=(0,a.useState)(!1),[v,y]=(0,a.useState)(l||null),[b,w]=(0,a.useState)("captcha"),S=(e,t)=>{g(s=>s.find(t=>t.questionId===e)?s.map(s=>s.questionId===e?{...s,value:t}:s):[...s,{questionId:e,value:t}])},j=async()=>{if(!u){y("Please complete the CAPTCHA verification");return}if(s.length>0&&h.length<s.length){y("Please answer all questions");return}f(!0),y(null),w("processing");try{let s=m(),r=await o.default.post("/api/verify/captcha",{token:u,projectId:e,uid:t,clientMetadata:s,answers:h});r.data.success?(await o.default.post("/api/links/update-status",{projectId:e,uid:t,status:"STARTED",token:r.data.sessionToken}),sessionStorage.setItem("surveySession",JSON.stringify({token:r.data.sessionToken,projectId:e,uid:t,answers:h})),d.push(`/survey/${e}/${t}`)):(y(r.data.message||"Verification failed"),w("captcha"))}catch(e){y(e?.response?.data?.message||"An error occurred during verification"),w("captcha")}finally{f(!1)}};return r?i.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:(0,i.jsxs)("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md w-full",children:[i.jsx("h1",{className:"text-2xl font-bold text-gray-800 mb-4",children:"Survey Verification"}),"captcha"===b&&(0,i.jsxs)("div",{className:"space-y-6",children:[i.jsx("p",{className:"text-gray-600 mb-4",children:"Please complete the verification below to access the survey."}),i.jsx("div",{className:"flex justify-center",children:i.jsx(c(),{sitekey:"10000000-ffff-ffff-ffff-000000000001",onVerify:e=>{p(e),0===s.length?j():w("questions")}})})]}),"questions"===b&&(0,i.jsxs)("div",{className:"space-y-6",children:[i.jsx("p",{className:"text-gray-600 mb-4",children:"Please answer the following questions before proceeding to the survey:"}),s.map(e=>(0,i.jsxs)("div",{className:"mb-4",children:[i.jsx("p",{className:"font-medium mb-2",children:e.text}),i.jsx("div",{className:"space-y-2",children:e.options.map((t,s)=>(0,i.jsxs)("div",{className:"flex items-center",children:[i.jsx("input",{type:"radio",id:`q${e.id}-${s}`,name:`question-${e.id}`,value:t,onChange:()=>S(e.id,t),className:"mr-2"}),i.jsx("label",{htmlFor:`q${e.id}-${s}`,children:t})]},s))})]},e.id)),i.jsx("button",{onClick:j,disabled:x||h.length<s.length,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50",children:x?"Processing...":"Continue to Survey"})]}),"processing"===b&&(0,i.jsxs)("div",{className:"text-center",children:[i.jsx("p",{className:"text-gray-600 mb-4",children:"Verifying your information..."}),i.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto"})]}),v&&i.jsx("div",{className:"mt-4 p-3 bg-red-100 text-red-700 rounded-md",children:v})]})}):i.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100",children:(0,i.jsxs)("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md w-full",children:[i.jsx("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Error"}),i.jsx("p",{className:"text-gray-700",children:v||"This survey link is invalid or has expired."})]})})}async function h(e){let{projectId:t,uid:s}=e.params;if(!t||!s)return{props:{isValid:!1,errorMessage:"Invalid URL parameters",projectId:"",uid:"",questions:[]}};try{if(!await d._.surveyLink.findFirst({where:{projectId:t,uid:s,status:"PENDING"}}))return{props:{isValid:!1,errorMessage:"This survey link is invalid or has already been used",projectId:t,uid:s,questions:[]}};let e=(await d._.question.findMany({where:{projectId:t},select:{id:!0,text:!0,options:!0}})).map(e=>({id:e.id,text:e.text,options:JSON.parse(e.options||"[]")}));return{props:{isValid:!0,projectId:t,uid:s,questions:JSON.parse(JSON.stringify(e))}}}catch(e){return console.error("Error fetching survey data:",e),{props:{isValid:!1,errorMessage:"Failed to load survey information",projectId:t,uid:s,questions:[]}}}}r()}catch(e){r(e)}})},108:()=>{},2534:e=>{"use strict";e.exports=require("@hcaptcha/react-hcaptcha")},2785:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/pages.runtime.prod.js")},968:e=>{"use strict";e.exports=require("next/head")},6689:e=>{"use strict";e.exports=require("react")},6405:e=>{"use strict";e.exports=require("react-dom")},997:e=>{"use strict";e.exports=require("react/jsx-runtime")},2048:e=>{"use strict";e.exports=require("fs")},5315:e=>{"use strict";e.exports=require("path")},6162:e=>{"use strict";e.exports=require("stream")},1568:e=>{"use strict";e.exports=require("zlib")},9648:e=>{"use strict";e.exports=import("axios")}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[899,132,163],()=>s(5277));module.exports=r})();