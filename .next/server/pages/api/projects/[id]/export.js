"use strict";(()=>{var e={};e.id=555,e.ids=[555],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1534:e=>{e.exports=import("aws-amplify/api")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},5027:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>c,default:()=>l,routeModule:()=>u});var n=a(1802),s=a(7153),o=a(6249),d=a(9563),i=e([d]);d=(i.then?(await i)():i)[0];let l=(0,o.l)(d,"default"),c=(0,o.l)(d,"config"),u=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/projects/[id]/export",pathname:"/api/projects/[id]/export",bundlePath:"",filename:""},userland:d});r()}catch(e){r(e)}})},5746:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{K:()=>l});var n=a(1534),s=e([n]);n=(s.then?(await s)():s)[0];let o=(0,n.generateClient)({authMode:"apiKey"}),d=e=>e.data,i=(e,t)=>{let a={operation:t,name:e instanceof Error?e.name:"UnknownError",message:e instanceof Error?e.message:"Unknown error occurred",details:e};throw"object"==typeof e&&null!==e&&"code"in e&&(a.code=String(e.code)),console.error(`Amplify Error (${t}):`,a),e},l={client:o,projects:{create:async e=>{try{let t=await o.models.Project.create(e);return{data:d(t)}}catch(e){i(e,"projects.create")}},get:async e=>{let t=await o.models.Project.get({id:e});return{data:d(t)}},list:async e=>({data:(await o.models.Project.list(e)).data||[]}),update:async(e,t)=>{let a=await o.models.Project.update({id:e,...t});return{data:d(a)}},delete:async e=>{let t=await o.models.Project.delete({id:e});return{data:d(t)}},getWithRelations:async e=>{let t=await o.models.Project.get({id:e});if(t.data){let a=await o.models.SurveyLink.list({filter:{projectId:{eq:e}}}),r=(await o.models.ProjectVendor.list({filter:{projectId:{eq:e}}})).data.map(e=>e.vendorId).filter(e=>null!=e),n=[];r.length>0&&(n=(await Promise.all(r.map(e=>o.models.Vendor.get({id:e})))).filter(e=>null!==e.data).map(e=>e.data));let s=await o.models.Question.list({filter:{projectId:{eq:e}}});return{data:{...t.data,surveyLinks:a.data||[],vendors:n,questions:s.data||[]}}}return{data:null}}},surveyLinks:{create:async e=>{let t=await o.models.SurveyLink.create(e);return{data:d(t)}},get:async e=>{let t=await o.models.SurveyLink.get({id:e});return{data:d(t)}},getByUid:async e=>{let t=await o.models.SurveyLink.list({filter:{uid:{eq:e}}});return{data:t.data&&t.data.length>0?t.data[0]:null}},update:async(e,t)=>{let a=await o.models.SurveyLink.update({id:e,...t});return{data:d(a)}},list:async e=>({data:(await o.models.SurveyLink.list(e)).data||[]}),listByProject:async e=>({data:(await o.models.SurveyLink.list({filter:{projectId:{eq:e}}})).data||[]}),delete:async e=>{let t=await o.models.SurveyLink.delete({id:e});return{data:d(t)}}},vendors:{create:async e=>{let t=await o.models.Vendor.create(e);return{data:d(t)}},get:async e=>{let t=await o.models.Vendor.get({id:e});return{data:d(t)}},list:async e=>({data:(await o.models.Vendor.list(e)).data||[]}),listByProject:async e=>{let t=(await o.models.ProjectVendor.list({filter:{projectId:{eq:e}}})).data.map(e=>e.vendorId).filter(e=>null!=e);return t.length>0?{data:(await Promise.all(t.map(e=>o.models.Vendor.get({id:e})))).filter(e=>null!==e.data).map(e=>e.data)}:{data:[]}},update:async(e,t)=>{let a=await o.models.Vendor.update({id:e,...t});return{data:d(a)}},delete:async e=>{let t=await o.models.Vendor.delete({id:e});return{data:d(t)}}},questions:{create:async e=>{let t=await o.models.Question.create(e);return{data:d(t)}},get:async e=>{let t=await o.models.Question.get({id:e});return{data:d(t)}},list:async e=>({data:(await o.models.Question.list(e)).data||[]}),listByProject:async e=>({data:(await o.models.Question.list({filter:{projectId:{eq:e}}})).data||[]}),update:async(e,t)=>{let a=await o.models.Question.update({id:e,...t});return{data:d(a)}},delete:async e=>{let t=await o.models.Question.delete({id:e});return{data:d(t)}}},transaction:{execute:async e=>{let t=[];for(let a of e){let e=await a;t.push(e)}return t}}};r()}catch(e){r(e)}})},9563:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>o});var n=a(5746),s=e([n]);async function o(e,t){if("GET"!==e.method)return t.status(405).json({message:"Method not allowed"});let{id:a}=e.query,{vendor:r,dateRange:s,format:o="csv"}=e.query;if(!a||"string"!=typeof a)return t.status(400).json({success:!1,message:"Project ID is required"});try{let e=await n.K.projects.get(a);if(!e||!e.data)return t.status(404).json({success:!1,message:"Project not found"});let d=e.data,i={projectId:{eq:a}};if(r&&"string"==typeof r&&(i.vendorId={eq:r}),s){let e=new Date,t={};switch(s){case"today":t={ge:new Date(e.setHours(0,0,0,0)).toISOString()};break;case"yesterday":let a=new Date(e);a.setDate(a.getDate()-1),a.setHours(0,0,0,0);let r=new Date(e);r.setDate(r.getDate()-1),r.setHours(23,59,59,999),t={ge:a.toISOString(),le:r.toISOString()};break;case"week":let n=new Date(e);n.setDate(n.getDate()-7),t={ge:n.toISOString()};break;case"month":let o=new Date(e);o.setDate(o.getDate()-30),t={ge:o.toISOString()}}Object.keys(t).length>0&&(i.createdAt=t)}let l=(await n.K.surveyLinks.list({filter:i})).data||[];if(0===l.length){let e="json"===o?{success:!0,project:{id:d.id,name:d.name},data:[]}:"";if("json"===o)return t.status(200).json(e);return t.setHeader("Content-Type","text/csv"),t.setHeader("Content-Disposition",`attachment; filename=${d.name.replace(/\s+/g,"_")}_export_${new Date().toISOString().split("T")[0]}.csv`),t.status(200).send("ID,UID,Original URL,Status,Link Type,Vendor Name,Vendor Code,Country,Device,Browser,Flags,Created At,Updated At")}l.map(e=>e.id).filter(e=>null!=e);let c=l.filter(e=>e.vendorId).map(e=>e.vendorId).filter(e=>null!=e),u=(c.length>0?await n.K.vendors.list({filter:{id:{in:c}}}):{data:[]}).data||[],p={};u.forEach(e=>{if(!e.id)throw Error("Vendor ID is null or undefined");p[e.id]=e});let m={},y={};l.forEach(e=>{if(e.id&&e.metadata)try{let t=JSON.parse(e.metadata);t.responses&&Array.isArray(t.responses)&&(m[e.id]=t.responses),(t.flagged||t.flags&&Array.isArray(t.flags))&&(y[e.id]=t.flags||[{reason:t.flagReason||"Unknown reason",timestamp:t.flaggedAt||new Date().toISOString(),metadata:t.flagMetadata||{}}])}catch(t){console.error(`Error parsing metadata for link ${e.id}:`,t)}});let g=l.map(e=>{if(!e.id)return null;let t={},a=e.id&&m[e.id]||[];if(a.length>0&&a[0].metadata)try{t=JSON.parse(a[0].metadata)}catch(e){console.error("Error parsing metadata:",e)}let r=t?.geoLocation?.country||t?.ip_location?.country||t?.country||"Unknown",n=t?.device||"Unknown",s=t?.browser||"Unknown",o=(e.id&&y[e.id]||[]).map(e=>e.reason).join("; "),d=e.vendorId&&p[e.vendorId]?p[e.vendorId]:null,i=d?d.name:"None",l="None";if(d&&d.settings)try{l=JSON.parse(d.settings).code||"None"}catch(e){console.error("Error parsing vendor settings:",e)}let c="",u="LIVE";if(e.metadata)try{let t=JSON.parse(e.metadata);c=t.originalUrl||"",u=t.linkType||"LIVE"}catch(e){console.error("Error parsing link metadata:",e)}return{id:e.id,uid:e.uid,originalUrl:c,status:e.status||"UNUSED",linkType:u,vendorName:i,vendorCode:l,country:r,device:n,browser:s,flags:o,createdAt:e.createdAt||new Date().toISOString(),updatedAt:e.updatedAt||e.createdAt||new Date().toISOString()}}).filter(Boolean);if("json"===o)return t.status(200).json({success:!0,project:{id:d.id,name:d.name},data:g});{let e=g.map(e=>e?[e.id,e.uid,`"${e.originalUrl}"`,e.status,e.linkType,`"${e.vendorName}"`,e.vendorCode,`"${e.country}"`,e.device,e.browser,`"${e.flags}"`,e.createdAt,e.updatedAt].join(","):""),a=["ID,UID,Original URL,Status,Link Type,Vendor Name,Vendor Code,Country,Device,Browser,Flags,Created At,Updated At",...e].join("\n");return t.setHeader("Content-Type","text/csv"),t.setHeader("Content-Disposition",`attachment; filename=${d.name.replace(/\s+/g,"_")}_export_${new Date().toISOString().split("T")[0]}.csv`),t.status(200).send(a)}}catch(e){return console.error("Error exporting project data:",e),t.status(500).json({success:!1,message:"Failed to export data"})}}n=(s.then?(await s)():s)[0],r()}catch(e){r(e)}})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=5027);module.exports=a})();