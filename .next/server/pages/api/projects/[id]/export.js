"use strict";(()=>{var e={};e.id=555,e.ids=[555],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5838:e=>{e.exports=import("aws-amplify")},5027:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>c,default:()=>l,routeModule:()=>u});var n=a(1802),s=a(7153),o=a(6249),i=a(9563),d=e([i]);i=(d.then?(await d)():d)[0];let l=(0,o.l)(i,"default"),c=(0,o.l)(i,"config"),u=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/projects/[id]/export",pathname:"/api/projects/[id]/export",bundlePath:"",filename:""},userland:i});r()}catch(e){r(e)}})},9563:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>o});var n=a(9519),s=e([n]);async function o(e,t){if("GET"!==e.method)return t.status(405).json({message:"Method not allowed"});let{id:a}=e.query,{vendor:r,dateRange:s,format:o="csv"}=e.query;if(!a||"string"!=typeof a)return t.status(400).json({success:!1,message:"Project ID is required"});try{let e=(0,n.j)(),i=(await e.getProject(a)).data;if(!i)return t.status(404).json({success:!1,message:"Project not found"});let d={projectId:{eq:a}};if(r&&"string"==typeof r&&(d.vendorId={eq:r}),s){let e=new Date,t={};switch(s){case"today":t={ge:new Date(e.setHours(0,0,0,0)).toISOString()};break;case"yesterday":let a=new Date(e);a.setDate(a.getDate()-1),a.setHours(0,0,0,0);let r=new Date(e);r.setDate(r.getDate()-1),r.setHours(23,59,59,999),t={ge:a.toISOString(),le:r.toISOString()};break;case"week":let n=new Date(e);n.setDate(n.getDate()-7),t={ge:n.toISOString()};break;case"month":let o=new Date(e);o.setDate(o.getDate()-30),t={ge:o.toISOString()}}Object.keys(t).length>0&&(d.createdAt=t)}let l=(await e.listSurveyLinksByProject(a)).data,c=l;if(r&&"string"==typeof r&&(c=l.filter(e=>e.vendorId===r)),s){let e=new Date,t=null,a=null;switch(s){case"today":t=new Date(e.setHours(0,0,0,0));break;case"yesterday":(t=new Date(e)).setDate(t.getDate()-1),t.setHours(0,0,0,0),(a=new Date(e)).setDate(a.getDate()-1),a.setHours(23,59,59,999);break;case"week":(t=new Date(e)).setDate(t.getDate()-7);break;case"month":(t=new Date(e)).setDate(t.getDate()-30)}t&&(c=c.filter(e=>{let r=new Date(e.createdAt);return a?r>=t&&r<=a:r>=t}))}if(0===c.length){let e="json"===o?{success:!0,project:{id:i.id,name:i.name},data:[]}:"";if("json"===o)return t.status(200).json(e);return t.setHeader("Content-Type","text/csv"),t.setHeader("Content-Disposition",`attachment; filename=${i.name.replace(/\s+/g,"_")}_export_${new Date().toISOString().split("T")[0]}.csv`),t.status(200).send("ID,UID,Original URL,Status,Link Type,Vendor Name,Vendor Code,Country,Device,Browser,Flags,Created At,Updated At")}c.map(e=>e.id).filter(e=>null!=e);let u=c.filter(e=>e.vendorId).map(e=>e.vendorId).filter(e=>null!=e),g=await Promise.all(Array.from(new Set(u)).map(t=>e.getVendor(t))),p={};g.forEach(e=>{let t=e.data;t&&t.id&&(p[t.id]=t)});let m={},f={};c.forEach(e=>{if(e.id&&e.metadata)try{let t=JSON.parse(e.metadata);t.responses&&Array.isArray(t.responses)&&(m[e.id]=t.responses),(t.flagged||t.flags&&Array.isArray(t.flags))&&(f[e.id]=t.flags||[{reason:t.flagReason||"Unknown reason",timestamp:t.flaggedAt||new Date().toISOString(),metadata:t.flagMetadata||{}}])}catch(t){console.error(`Error parsing metadata for link ${e.id}:`,t)}});let D=c.map(e=>{if(!e.id)return null;let t={},a=e.id&&m[e.id]||[];if(a.length>0&&a[0].metadata)try{t=JSON.parse(a[0].metadata)}catch(e){console.error("Error parsing metadata:",e)}let r=t?.geoLocation?.country||t?.ip_location?.country||t?.country||"Unknown",n=t?.device||"Unknown",s=t?.browser||"Unknown",o=(e.id&&f[e.id]||[]).map(e=>e.reason).join("; "),i=e.vendorId&&p[e.vendorId]?p[e.vendorId]:null,d=i?i.name:"None",l="None";if(i&&i.settings)try{l=JSON.parse(i.settings).code||"None"}catch(e){console.error("Error parsing vendor settings:",e)}let c="",u="LIVE";if(e.metadata)try{let t=JSON.parse(e.metadata);c=t.originalUrl||"",u=t.linkType||"LIVE"}catch(e){console.error("Error parsing link metadata:",e)}return{id:e.id,uid:e.uid,originalUrl:c,status:e.status||"UNUSED",linkType:u,vendorName:d,vendorCode:l,country:r,device:n,browser:s,flags:o,createdAt:e.createdAt||new Date().toISOString(),updatedAt:e.updatedAt||e.createdAt||new Date().toISOString()}}).filter(Boolean);if("json"===o)return t.status(200).json({success:!0,project:{id:i.id,name:i.name},data:D});{let e=D.map(e=>e?[e.id,e.uid,`"${e.originalUrl}"`,e.status,e.linkType,`"${e.vendorName}"`,e.vendorCode,`"${e.country}"`,e.device,e.browser,`"${e.flags}"`,e.createdAt,e.updatedAt].join(","):""),a=["ID,UID,Original URL,Status,Link Type,Vendor Name,Vendor Code,Country,Device,Browser,Flags,Created At,Updated At",...e].join("\n");return t.setHeader("Content-Type","text/csv"),t.setHeader("Content-Disposition",`attachment; filename=${i.name.replace(/\s+/g,"_")}_export_${new Date().toISOString().split("T")[0]}.csv`),t.status(200).send(a)}}catch(e){return console.error("Error exporting project data:",e),t.status(500).json({success:!1,message:"Failed to export data"})}}n=(s.then?(await s)():s)[0],r()}catch(e){r(e)}})}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[6504],()=>a(5027));module.exports=r})();