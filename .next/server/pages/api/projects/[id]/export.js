"use strict";(()=>{var e={};e.id=555,e.ids=[555],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},5838:e=>{e.exports=import("aws-amplify")},1534:e=>{e.exports=import("aws-amplify/api")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},5027:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>c,default:()=>l,routeModule:()=>u});var s=a(1802),n=a(7153),d=a(6249),i=a(9563),o=e([i]);i=(o.then?(await o)():o)[0];let l=(0,d.l)(i,"default"),c=(0,d.l)(i,"config"),u=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/projects/[id]/export",pathname:"/api/projects/[id]/export",bundlePath:"",filename:""},userland:i});r()}catch(e){r(e)}})},5112:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{Ao:()=>d});var s=a(5838),n=e([s]);s=(n.then?(await n)():n)[0];let d={Auth:{Cognito:{userPoolId:"us-east-1_QIwwMdokt",userPoolClientId:"your_client_id_here",identityPoolId:"your_identity_pool_id_here"}},API:{GraphQL:{endpoint:"https://235kq6cpbbdyfizalvutob7vh4.appsync-api.us-east-1.amazonaws.com/graphql",region:"us-east-1",defaultAuthMode:"userPool"}},domains:{main:"protegeresearchsurvey.com",admin:"admin.protegeresearchsurvey.com"}};r()}catch(e){r(e)}})},5746:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{K:()=>c});var s=a(1534),n=a(5838),d=a(5112),i=e([s,n,d]);[s,n,d]=i.then?(await i)():i,n.Amplify.configure(d.Ao);let o=(0,s.generateClient)(),l=e=>e.data,c={projects:{create:async e=>{let t=await o.models.Project.create(e);return{data:l(t)}},get:async e=>{let t=await o.models.Project.get({id:e});return{data:l(t)}},list:async e=>({data:(await o.models.Project.list(e)).data||[]}),update:async(e,t)=>{let a=await o.models.Project.update({id:e,...t});return{data:l(a)}},delete:async e=>{let t=await o.models.Project.delete({id:e});return{data:l(t)}},getWithRelations:async e=>{let t=await o.models.Project.get({id:e});if(t.data){let a=await o.models.SurveyLink.list({filter:{projectId:{eq:e}}}),r=await o.models.Vendor.list({filter:{projectId:{eq:e}}}),s=await o.models.Question.list({filter:{projectId:{eq:e}}});return{data:{...t.data,surveyLinks:a.data||[],vendors:r.data||[],questions:s.data||[]}}}return{data:null}}},surveyLinks:{create:async e=>{let t=await o.models.SurveyLink.create(e);return{data:l(t)}},get:async e=>{let t=await o.models.SurveyLink.get({id:e});return{data:l(t)}},getByUid:async e=>{let t=await o.models.SurveyLink.list({filter:{uid:{eq:e}}});return{data:t.data&&t.data.length>0?t.data[0]:null}},update:async(e,t)=>{let a=await o.models.SurveyLink.update({id:e,...t});return{data:l(a)}},list:async e=>({data:(await o.models.SurveyLink.list(e)).data||[]}),listByProject:async e=>({data:(await o.models.SurveyLink.list({filter:{projectId:{eq:e}}})).data||[]}),delete:async e=>{let t=await o.models.SurveyLink.delete({id:e});return{data:l(t)}}},vendors:{create:async e=>{let t=await o.models.Vendor.create(e);return{data:l(t)}},get:async e=>{let t=await o.models.Vendor.get({id:e});return{data:l(t)}},list:async e=>({data:(await o.models.Vendor.list(e)).data||[]}),listByProject:async e=>({data:(await o.models.Vendor.list({filter:{projectId:{eq:e}}})).data||[]}),update:async(e,t)=>{let a=await o.models.Vendor.update({id:e,...t});return{data:l(a)}},delete:async e=>{let t=await o.models.Vendor.delete({id:e});return{data:l(t)}}},questions:{create:async e=>{let t=await o.models.Question.create(e);return{data:l(t)}},get:async e=>{let t=await o.models.Question.get({id:e});return{data:l(t)}},list:async e=>({data:(await o.models.Question.list(e)).data||[]}),listByProject:async e=>({data:(await o.models.Question.list({filter:{projectId:{eq:e}}})).data||[]}),update:async(e,t)=>{let a=await o.models.Question.update({id:e,...t});return{data:l(a)}},delete:async e=>{let t=await o.models.Question.delete({id:e});return{data:l(t)}}},responses:{create:async e=>{let t=await o.models.Response.create(e);return{data:l(t)}},get:async e=>{let t=await o.models.Response.get({id:e});return{data:l(t)}},list:async e=>({data:(await o.models.Response.list(e)).data||[]}),listByProject:async e=>({data:(await o.models.Response.list({filter:{projectId:{eq:e}}})).data||[]}),listBySurveyLink:async e=>({data:(await o.models.Response.list({filter:{surveyLinkId:{eq:e}}})).data||[]}),delete:async e=>{let t=await o.models.Response.delete({id:e});return{data:l(t)}}},flags:{create:async e=>{let t=await o.models.Flag.create(e);return{data:l(t)}},get:async e=>{let t=await o.models.Flag.get({id:e});return{data:l(t)}},list:async e=>({data:(await o.models.Flag.list(e)).data||[]}),listByProject:async e=>({data:(await o.models.Flag.list({filter:{projectId:{eq:e}}})).data||[]}),listBySurveyLink:async e=>({data:(await o.models.Flag.list({filter:{surveyLinkId:{eq:e}}})).data||[]}),delete:async e=>{let t=await o.models.Flag.delete({id:e});return{data:l(t)}}},transaction:{execute:async e=>{let t=[];for(let a of e){let e=await a;t.push(e)}return t}}};r()}catch(e){r(e)}})},9563:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>d});var s=a(5746),n=e([s]);async function d(e,t){if("GET"!==e.method)return t.status(405).json({message:"Method not allowed"});let{id:a}=e.query,{vendor:r,dateRange:n,format:d="csv"}=e.query;if(!a||"string"!=typeof a)return t.status(400).json({success:!1,message:"Project ID is required"});try{let e=await s.K.projects.get(a);if(!e||!e.data)return t.status(404).json({success:!1,message:"Project not found"});let i=e.data,o={projectId:{eq:a}};if(r&&"string"==typeof r&&(o.vendorId={eq:r}),n){let e=new Date,t={};switch(n){case"today":t={ge:new Date(e.setHours(0,0,0,0)).toISOString()};break;case"yesterday":let a=new Date(e);a.setDate(a.getDate()-1),a.setHours(0,0,0,0);let r=new Date(e);r.setDate(r.getDate()-1),r.setHours(23,59,59,999),t={ge:a.toISOString(),le:r.toISOString()};break;case"week":let s=new Date(e);s.setDate(s.getDate()-7),t={ge:s.toISOString()};break;case"month":let d=new Date(e);d.setDate(d.getDate()-30),t={ge:d.toISOString()}}Object.keys(t).length>0&&(o.createdAt=t)}let l=(await s.K.surveyLinks.list({filter:o})).data||[];if(0===l.length){let e="json"===d?{success:!0,project:{id:i.id,name:i.name},data:[]}:"";if("json"===d)return t.status(200).json(e);return t.setHeader("Content-Type","text/csv"),t.setHeader("Content-Disposition",`attachment; filename=${i.name.replace(/\s+/g,"_")}_export_${new Date().toISOString().split("T")[0]}.csv`),t.status(200).send("ID,UID,Original URL,Status,Link Type,Vendor Name,Vendor Code,Country,Device,Browser,Flags,Created At,Updated At")}let c=l.map(e=>e.id).filter(e=>null!=e),u=l.filter(e=>e.vendorId).map(e=>e.vendorId).filter(e=>null!=e),y=(u.length>0?await s.K.vendors.list({filter:{id:{in:u}}}):{data:[]}).data||[],p={};y.forEach(e=>{if(!e.id)throw Error("Vendor ID is null or undefined");p[e.id]=e});let m=c.map(e=>s.K.responses.list({filter:{surveyLinkId:{eq:e}}})),g=await Promise.all(m),w=c.map(e=>s.K.flags.list({filter:{surveyLinkId:{eq:e}}})),f=await Promise.all(w),v={};g.forEach((e,t)=>{e.data&&e.data.length>0&&(v[c[t]]=e.data)});let j={};f.forEach((e,t)=>{e.data&&e.data.length>0&&(j[c[t]]=e.data)});let h=l.map(e=>{if(!e.id)return null;let t={},a=e.id&&v[e.id]||[];if(a.length>0&&a[0].metadata)try{t=JSON.parse(a[0].metadata)}catch(e){console.error("Error parsing metadata:",e)}let r=t?.geoLocation?.country||t?.ip_location?.country||t?.country||"Unknown",s=t?.device||"Unknown",n=t?.browser||"Unknown",d=(e.id&&j[e.id]||[]).map(e=>e.reason).join("; "),i=e.vendorId&&p[e.vendorId]?p[e.vendorId]:null,o=i?i.name:"None",l=i?i.code:"None";return{id:e.id,uid:e.uid,originalUrl:e.originalUrl,status:e.status||"PENDING",linkType:e.linkType||"LIVE",vendorName:o,vendorCode:l,country:r,device:s,browser:n,flags:d,createdAt:e.createdAt||new Date().toISOString(),updatedAt:e.updatedAt||e.createdAt||new Date().toISOString()}}).filter(Boolean);if("json"===d)return t.status(200).json({success:!0,project:{id:i.id,name:i.name},data:h});{let e=h.map(e=>e?[e.id,e.uid,`"${e.originalUrl}"`,e.status,e.linkType,`"${e.vendorName}"`,e.vendorCode,`"${e.country}"`,e.device,e.browser,`"${e.flags}"`,e.createdAt,e.updatedAt].join(","):""),a=["ID,UID,Original URL,Status,Link Type,Vendor Name,Vendor Code,Country,Device,Browser,Flags,Created At,Updated At",...e].join("\n");return t.setHeader("Content-Type","text/csv"),t.setHeader("Content-Disposition",`attachment; filename=${i.name.replace(/\s+/g,"_")}_export_${new Date().toISOString().split("T")[0]}.csv`),t.status(200).send(a)}}catch(e){return console.error("Error exporting project data:",e),t.status(500).json({success:!1,message:"Failed to export data"})}}s=(n.then?(await n)():n)[0],r()}catch(e){r(e)}})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=5027);module.exports=a})();