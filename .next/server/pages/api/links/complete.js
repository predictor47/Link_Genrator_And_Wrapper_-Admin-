"use strict";(()=>{var e={};e.id=4935,e.ids=[4935],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5838:e=>{e.exports=import("aws-amplify")},1866:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{config:()=>c,default:()=>u,routeModule:()=>l});var r=s(1802),n=s(7153),i=s(6249),o=s(3622),d=e([o]);o=(d.then?(await d)():d)[0];let u=(0,i.l)(o,"default"),c=(0,i.l)(o,"config"),l=new r.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/links/complete",pathname:"/api/links/complete",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},3622:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{default:()=>i});var r=s(9519),n=e([r]);async function i(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let s=(0,r.j)(),{projectId:a,uid:n,token:i,vendorId:o,metadata:d}=e.body;if(!a||!n)return t.status(400).json({success:!1,message:"Missing required fields"});let u=(await s.getSurveyLinkByUid(n)).data;if(!u)return t.status(404).json({success:!1,message:"Survey link not found"});if("CLICKED"!==u.status)return t.status(400).json({success:!1,message:`Cannot complete survey from ${u.status} status`});let c=!1,l="";d&&(void 0!==d.consistencyScore&&d.consistencyScore<70&&(c=!0,l=`Low metadata consistency score: ${d.consistencyScore}/100`),d.initialMetadata&&d.initialMetadata.ip&&d.ip&&d.initialMetadata.ip!==d.ip&&(c=!0,l="IP address changed during survey"));let m={status:"COMPLETED",completedAt:new Date().toISOString()},p={...d,completionTimestamp:new Date().toISOString()};if(c&&(p.flagged=!0,p.flagReason=l,p.flaggedAt=new Date().toISOString()),m.metadata=JSON.stringify(p),o&&o!==u.vendorId&&(await s.listProjectVendors({and:[{projectId:{eq:a}},{vendorId:{eq:o}}]})).data.find(e=>e.vendorId===o)&&(m.vendorId=o),!u.id)throw Error("Survey link ID is null or undefined");return await s.updateSurveyLink(u.id,m),t.status(200).json({success:!0,message:"Survey marked as completed successfully"})}catch(e){return console.error("Error completing survey:",e),t.status(500).json({success:!1,message:"Internal server error"})}}r=(n.then?(await n)():n)[0],a()}catch(e){a(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[6504],()=>s(1866));module.exports=a})();