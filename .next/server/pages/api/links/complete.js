"use strict";(()=>{var e={};e.id=935,e.ids=[935],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},5838:e=>{e.exports=import("aws-amplify")},1534:e=>{e.exports=import("aws-amplify/api")},376:e=>{e.exports=import("aws-amplify/data")},1866:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{config:()=>l,default:()=>u,routeModule:()=>c});var r=s(1802),i=s(7153),n=s(6249),o=s(3622),d=e([o]);o=(d.then?(await d)():d)[0];let u=(0,n.l)(o,"default"),l=(0,n.l)(o,"config"),c=new r.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/links/complete",pathname:"/api/links/complete",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},3622:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{default:()=>n});var r=s(5746),i=e([r]);async function n(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let{projectId:s,uid:a,token:i,vendorId:n,metadata:o}=e.body;if(!s||!a)return t.status(400).json({success:!1,message:"Missing required fields"});let d=await r.K.surveyLinks.getByUid(a),u=d?.data;if(!u)return t.status(404).json({success:!1,message:"Survey link not found"});if("CLICKED"!==u.status)return t.status(400).json({success:!1,message:`Cannot complete survey from ${u.status} status`});let l=!1,c="";o&&(void 0!==o.consistencyScore&&o.consistencyScore<70&&(l=!0,c=`Low metadata consistency score: ${o.consistencyScore}/100`),o.initialMetadata&&o.initialMetadata.ip&&o.ip&&o.initialMetadata.ip!==o.ip&&(l=!0,c="IP address changed during survey"));let p={status:"COMPLETED",completedAt:new Date().toISOString()},m={...o,completionTimestamp:new Date().toISOString()};if(l&&(m.flagged=!0,m.flagReason=c,m.flaggedAt=new Date().toISOString()),p.metadata=JSON.stringify(m),n&&n!==u.vendorId){let e=await r.K.vendors.list({filter:{and:[{id:{eq:n}},{projectId:{eq:s}}]}});e.data&&e.data.length>0&&(p.vendorId=n)}if(!u.id)throw Error("Survey link ID is null or undefined");return await r.K.surveyLinks.update(u.id,p),t.status(200).json({success:!0,message:"Survey marked as completed successfully"})}catch(e){return console.error("Error completing survey:",e),t.status(500).json({success:!1,message:"Internal server error"})}}r=(i.then?(await i)():i)[0],a()}catch(e){a(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[463],()=>s(1866));module.exports=a})();