"use strict";(()=>{var e={};e.id=8478,e.ids=[8478],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5838:e=>{e.exports=import("aws-amplify")},1531:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{config:()=>d,default:()=>c,routeModule:()=>l});var o=t(1802),a=t(7153),i=t(6249),n=t(1387),u=e([n]);n=(u.then?(await u)():u)[0];let c=(0,i.l)(n,"default"),d=(0,i.l)(n,"config"),l=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/links/validate",pathname:"/api/links/validate",bundlePath:"",filename:""},userland:n});s()}catch(e){s(e)}})},1387:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{default:()=>n});var o=t(9519),a=e([o]);async function i(e){try{let r=e.headers["cf-ipcountry"];if(r&&"XX"!==r)return r;let t=e.headers["x-country-code"];if(t)return t;let s=e.headers["x-forwarded-for"]||e.headers["x-real-ip"]||e.connection.remoteAddress||e.socket.remoteAddress||"";if(s.includes(",")&&(s=s.split(",")[0].trim()),!s||"127.0.0.1"===s||"::1"===s||s.startsWith("192.168.")||s.startsWith("10."))return"US";let o=new AbortController,a=setTimeout(()=>o.abort(),5e3),i=await fetch(`https://ipinfo.io/${s}/json`,{headers:{Accept:"application/json","User-Agent":"Survey-Wrapper/1.0"},signal:o.signal});if(clearTimeout(a),i.ok)return(await i.json()).country||null;return null}catch(e){return console.error("Error getting user country:",e),null}}async function n(e,r){if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});try{let{projectId:t,uid:s}=e.body;if(!t||!s)return r.status(400).json({success:!1,error:"Missing projectId or uid"});let a=(0,o.j)(),n=(await a.getSurveyLinkByUid(s)).data;if(!n)return r.status(404).json({success:!1,error:"Survey link not found",redirect:null});if(n.projectId!==t)return r.status(400).json({success:!1,error:"Invalid project/link combination",redirect:null});if("COMPLETED"===n.status)return r.status(200).json({success:!1,error:"Survey already completed",status:"completed",redirect:`/thank-you-completed?projectId=${t}`});if("DISQUALIFIED"===n.status)return r.status(200).json({success:!1,error:"User disqualified",status:"disqualified",redirect:`/sorry-disqualified?projectId=${t}`});if("QUOTA_FULL"===n.status)return r.status(200).json({success:!1,error:"Survey quota full",status:"quota-full",redirect:`/sorry-quota-full?projectId=${t}`});if(n.geoData&&"object"==typeof n.geoData)try{let t="string"==typeof n.geoData?JSON.parse(n.geoData):n.geoData;if(t.geoRestriction&&Array.isArray(t.geoRestriction)&&t.geoRestriction.length>0){let s=await i(e);if(s&&!t.geoRestriction.includes(s))return r.status(200).json({success:!1,error:"Geographic restriction",status:"geo-restricted",userCountry:s,allowedCountries:t.geoRestriction,redirect:`/geo-restricted?country=${s}&allowed=${t.geoRestriction.join(",")}`})}}catch(e){console.error("Error parsing geoData:",e)}let u=(await a.getProject(t)).data;if(!u)return r.status(404).json({success:!1,error:"Project not found",redirect:null});return"UNUSED"===n.status&&await a.updateSurveyLink(n.id,{status:"CLICKED"}),r.status(200).json({success:!0,project:{id:u.id,name:u.name,surveyUrl:u.surveyUrl||u.description||""},surveyLink:{id:n.id,uid:n.uid,status:"CLICKED",vendorId:n.vendorId,geoData:n.geoData},userCountry:await i(e)})}catch(e){return console.error("Survey validation error:",e),r.status(500).json({success:!1,error:"Internal server error",redirect:null})}}o=(a.then?(await a)():a)[0],s()}catch(e){s(e)}})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[6504],()=>t(1531));module.exports=s})();