(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[226],{4735:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/survey/[projectId]/[uid]",function(){return s(3057)}])},3057:function(e,t,s){"use strict";s.r(t),s.d(t,{__N_SSP:function(){return c},default:function(){return d}});var a=s(5893),i=s(7294),r=s(1163),n=s(7066),l=s(4155);async function o(e){try{let t=l.env.IPINFO_API_TOKEN;if(!t)return console.error("Missing IPINFO_API_TOKEN environment variable"),{isVpn:!1,isProxy:!1,isTor:!1,isRelay:!1,isHosting:!1,detectionSuccess:!1,error:"API token not configured"};let s=await fetch("https://ipinfo.io/".concat(e,"/privacy?token=").concat(t));if(!s.ok)throw Error("IPinfo API responded with status ".concat(s.status));let a=await s.json();if(!a.privacy)return{isVpn:!1,isProxy:!1,isTor:!1,isRelay:!1,isHosting:!1,detectionSuccess:!1,error:"Privacy detection not available with current IPinfo plan"};let{vpn:i,proxy:r,tor:n,relay:o,hosting:c,service:d}=a.privacy;return{isVpn:i,isProxy:r,isTor:n,isRelay:o,isHosting:c,service:d||"",detectionSuccess:!0,ipInfo:{ip:a.ip,city:a.city,region:a.region,country:a.country,org:a.org}}}catch(e){return console.error("VPN detection error:",e),{isVpn:!1,isProxy:!1,isTor:!1,isRelay:!1,isHosting:!1,detectionSuccess:!1,error:e instanceof Error?e.message:"Unknown error during VPN detection"}}}var c=!0;function d(e){let{isValid:t,originalUrl:s,geoRestriction:l,linkType:c,vendorCode:d,questions:u=[]}=e,m=(0,r.useRouter)(),[h,x]=(0,i.useState)(!0),[g,f]=(0,i.useState)(null),[p,y]=(0,i.useState)(!1),[w,v]=(0,i.useState)(!1),[b,j]=(0,i.useState)("Unknown"),[N,S]=(0,i.useState)(null),[I,k]=(0,i.useState)(""),[E,P]=(0,i.useState)(null),[T,q]=(0,i.useState)(!1),R=(0,i.useRef)(null),[_,A]=(0,i.useState)(!1),[V,C]=(0,i.useState)(null),[D,M]=(0,i.useState)(""),[O,F]=(0,i.useState)(null),[Z,L]=(0,i.useState)(null),[G,U]=(0,i.useState)(!1);(0,i.useEffect)(()=>{if(u.length>0&&!N){let e=Math.floor(Math.random()*u.length);S(u[e])}},[u]),(0,i.useEffect)(()=>(E&&T&&!Z&&u.length>0&&!_&&"LIVE"===c&&L(setTimeout(()=>{H()},1e3*Math.floor(91*Math.random()+30))),()=>{Z&&clearTimeout(Z)}),[E,T,u,_]);let H=()=>{if(0===u.length||!E)return;let e=u.filter(e=>E.answers.some(t=>t.questionId===e.id));if(e.length>0){let t=Math.floor(Math.random()*e.length);C(e[t]),A(!0),F(60);let s=setInterval(()=>{F(e=>null===e||e<=1?(clearInterval(s),B(),null):e-1)},1e3)}else L(setTimeout(()=>{H()},6e4))},B=async()=>{U(!0);try{await n.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"Mid-survey validation timeout",metadata:{questionId:null==V?void 0:V.id,timestamp:new Date().toISOString()}})}catch(e){console.error("Error flagging validation timeout:",e)}},J=async()=>{if(!V||!E)return;let e=E.answers.find(e=>e.questionId===V.id);if(e){if(e.value===D)A(!1),L(setTimeout(()=>{H()},1e3*Math.floor(91*Math.random()+30)));else{U(!0);try{await n.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"Mid-survey validation failed",metadata:{questionId:V.id,originalAnswer:e.value,newAnswer:D,timestamp:new Date().toISOString()}})}catch(e){console.error("Error flagging validation failure:",e)}}}};(0,i.useEffect)(()=>{(async()=>{if(t&&s){x(!0);try{let e=await n.Z.get("/api/ip-check"),t=await o(e.data.ip),s=e.data.country||"Unknown";j(s);let a=!l||!l.length||l.includes(s);t&&("LIVE"===c?(y(!0),await n.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"VPN detected",metadata:{ip:e.data.ip,country:s}})):(console.log("VPN detected but allowed in TEST mode"),await n.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"VPN detected (TEST link)",metadata:{ip:e.data.ip,country:s}}))),a||("LIVE"===c?(v(!0),await n.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"Geographic restriction violation",metadata:{ip:e.data.ip,country:s,allowedCountries:l}})):(console.log("Geo-restriction violated but allowed in TEST mode"),await n.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"Geographic restriction violation (TEST link)",metadata:{ip:e.data.ip,country:s,allowedCountries:l}})));let i=function(){let e={ip:null,userAgent:navigator.userAgent,browser:function(){let e=navigator.userAgent;return e.includes("Firefox")?"Firefox":e.includes("Chrome")?"Chrome":e.includes("Safari")&&!e.includes("Chrome")?"Safari":e.includes("Edge")?"Edge":e.includes("MSIE")||e.includes("Trident/")?"Internet Explorer":null}(),device:function(){let e=navigator.userAgent;return/Mobi|Android/i.test(e)&&!/Tablet|iPad/i.test(e)?"Mobile":/Tablet|iPad/i.test(e)?"Tablet":"Desktop"}(),language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timestamp:Date.now(),fingerprint:function(){let e=[navigator.userAgent,navigator.language,new Date().getTimezoneOffset(),screen.colorDepth,navigator.cookieEnabled,navigator.hardwareConcurrency,screen.width+"x"+screen.height,navigator.platform],t=0,s=e.join("###");for(let e=0;e<s.length;e++)t=(t<<5)-t+s.charCodeAt(e)|0;return t.toString(16)}(),screen:{width:window.screen.width,height:window.screen.height,colorDepth:window.screen.colorDepth,pixelRatio:window.devicePixelRatio||1},behavioral:{mouseMovements:0,keyboardEvents:0,totalTime:0,clickPattern:[]}};try{e.plugins=Array.from(navigator.plugins).map(e=>e.name);let t=document.createElement("canvas"),s=t.getContext("2d");s&&(t.width=200,t.height=50,s.textBaseline="top",s.font="14px Arial",s.fillStyle="#f60",s.fillRect(0,0,100,25),s.fillStyle="#069",s.fillText("Browser Fingerprint",2,15),s.fillStyle="rgba(102, 204, 0, 0.7)",s.fillText("Browser Fingerprint",4,17),e.canvas=t.toDataURL());try{let t=document.createElement("canvas").getContext("webgl");t&&(e.webGL={vendor:t.getParameter(t.VENDOR),renderer:t.getParameter(t.RENDERER)})}catch(e){}}catch(e){console.error("Error collecting advanced fingerprinting data:",e)}return e}();if(!p&&!w){let t="".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,15)),a={token:t,projectId:m.query.projectId,uid:m.query.uid,linkType:c,answers:N?[{questionId:N.id,value:I||""}]:[],metadata:{...i,ip:e.data.ip,country:s,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,vendor:d}};sessionStorage.setItem("surveySession",JSON.stringify(a)),P(a);try{await n.Z.post("/api/links/update-status",{projectId:m.query.projectId,uid:m.query.uid,status:"STARTED",token:t,metadata:a.metadata})}catch(e){console.error("Failed to update status to STARTED:",e)}}}catch(e){console.error("Error during security checks:",e),f("Failed to perform security checks. Please try again later.")}finally{x(!1)}}})()},[s,t,l,c,m.query,d]);let z=async()=>{if(!I||!N){f("Please select an answer to continue");return}try{let e=sessionStorage.getItem("surveySession");if(e){let t=JSON.parse(e),s=t.answers.findIndex(e=>e.questionId===N.id);s>=0?t.answers[s].value=I:t.answers.push({questionId:N.id,value:I}),sessionStorage.setItem("surveySession",JSON.stringify(t)),P(t),await n.Z.post("/api/links/update-status",{projectId:m.query.projectId,uid:m.query.uid,status:"IN_PROGRESS",questionId:N.id,answer:I,token:t.token})}S(null)}catch(e){console.error("Error saving answer:",e),f("Failed to save your answer. Please try again.")}};return t?h?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-800 mb-4",children:"Loading Survey"}),(0,a.jsx)("p",{className:"text-gray-600 mb-6",children:"Please wait while we set up your survey..."}),(0,a.jsx)("div",{className:"flex justify-center",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"})})]})}):g?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Error"}),(0,a.jsx)("p",{className:"text-gray-700 mb-6",children:g})]})}):p?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-amber-600 mb-4",children:"VPN Detected"}),(0,a.jsx)("p",{className:"text-gray-700 mb-6",children:"It appears you're using a VPN or proxy. To ensure data quality, please disable your VPN and refresh this page."}),(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"This helps us maintain the integrity of survey responses."})]})}):w?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Geographic Restriction"}),(0,a.jsxs)("p",{className:"text-gray-700 mb-6",children:["We're sorry, but this survey is not available in your country (",b,")."]}),(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"This survey is only available to participants from specific regions."})]})}):G?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Validation Failed"}),(0,a.jsx)("p",{className:"text-gray-700 mb-6",children:"Your answers were inconsistent with your previous responses. This survey has been marked for review."}),(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"Consistent answers are important for data quality."})]})}):N?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Pre-Survey Question"}),(0,a.jsx)("p",{className:"text-gray-500 text-sm mb-6",children:"Please answer this question before proceeding to the survey."}),(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("h2",{className:"text-lg font-medium text-gray-700 mb-3",children:N.text}),(0,a.jsx)("div",{className:"space-y-2",children:N.options.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("input",{id:"option-".concat(t),type:"radio",name:"question",value:e,className:"h-4 w-4 text-blue-600 focus:ring-blue-500",onChange:()=>k(e),checked:I===e}),(0,a.jsx)("label",{htmlFor:"option-".concat(t),className:"ml-2 block text-gray-700",children:e})]},t))})]}),(0,a.jsx)("button",{onClick:z,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline",children:"Continue to Survey"})]})}):_&&V?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-amber-600",children:"Verification Required"}),(0,a.jsxs)("div",{className:"text-amber-600 font-semibold",children:[O,"s"]})]}),(0,a.jsx)("p",{className:"text-gray-500 text-sm mb-6",children:"Please answer this question again to verify your identity."}),(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("h2",{className:"text-lg font-medium text-gray-700 mb-3",children:V.text}),(0,a.jsx)("div",{className:"space-y-2",children:V.options.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("input",{id:"mid-option-".concat(t),type:"radio",name:"mid-question",value:e,className:"h-4 w-4 text-blue-600 focus:ring-blue-500",onChange:()=>M(e),checked:D===e}),(0,a.jsx)("label",{htmlFor:"mid-option-".concat(t),className:"ml-2 block text-gray-700",children:e})]},t))})]}),(0,a.jsx)("button",{onClick:J,className:"w-full bg-amber-600 hover:bg-amber-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline",disabled:!D,children:"Verify & Continue"})]})}):(0,a.jsxs)("div",{className:"flex flex-col min-h-screen",children:[(0,a.jsx)("header",{className:"bg-white shadow-sm p-4",children:(0,a.jsx)("div",{className:"container mx-auto",children:(0,a.jsx)("h1",{className:"text-lg font-medium text-gray-800",children:"Survey in Progress"})})}),(0,a.jsx)("main",{className:"flex-grow relative",children:s&&(0,a.jsx)("iframe",{ref:R,src:s,className:"w-full h-full absolute top-0 left-0 border-0",onLoad:()=>{q(!0)},title:"Survey"})})]}):(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Invalid Survey Link"}),(0,a.jsx)("p",{className:"text-gray-700 mb-6",children:"This survey link is invalid or has expired. Please check the URL or contact the survey administrator."})]})})}},1163:function(e,t,s){e.exports=s(3079)}},function(e){e.O(0,[282,66,888,774,179],function(){return e(e.s=4735)}),_N_E=e.O()}]);