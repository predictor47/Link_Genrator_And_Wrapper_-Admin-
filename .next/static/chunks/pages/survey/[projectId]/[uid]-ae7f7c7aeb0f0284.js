(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[226],{4735:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/survey/[projectId]/[uid]",function(){return a(3057)}])},3057:function(e,t,a){"use strict";a.r(t),a.d(t,{__N_SSP:function(){return c},default:function(){return d}});var i=a(5893),r=a(7294),n=a(1163),s=a(7066),l=a(4155);async function o(e){try{let t=l.env.IPINFO_API_TOKEN;if(!t)return console.error("Missing IPINFO_API_TOKEN environment variable"),{isVpn:!1,isProxy:!1,isTor:!1,isRelay:!1,isHosting:!1,detectionSuccess:!1,error:"API token not configured"};let a=await fetch("https://ipinfo.io/".concat(e,"/privacy?token=").concat(t));if(!a.ok)throw Error("IPinfo API responded with status ".concat(a.status));let i=await a.json();if(!i.privacy)return{isVpn:!1,isProxy:!1,isTor:!1,isRelay:!1,isHosting:!1,detectionSuccess:!1,error:"Privacy detection not available with current IPinfo plan"};let{vpn:r,proxy:n,tor:s,relay:o,hosting:c,service:d}=i.privacy;return{isVpn:r,isProxy:n,isTor:s,isRelay:o,isHosting:c,service:d||"",detectionSuccess:!0,ipInfo:{ip:i.ip,city:i.city,region:i.region,country:i.country,org:i.org}}}catch(e){return console.error("VPN detection error:",e),{isVpn:!1,isProxy:!1,isTor:!1,isRelay:!1,isHosting:!1,detectionSuccess:!1,error:e instanceof Error?e.message:"Unknown error during VPN detection"}}}var c=!0;function d(e){let{isValid:t,originalUrl:a,geoRestriction:l,linkType:c,vendorCode:d,questions:u=[]}=e,m=(0,n.useRouter)(),[h,g]=(0,r.useState)(!0),[x,p]=(0,r.useState)(null),[f,y]=(0,r.useState)(!1),[v,w]=(0,r.useState)(!1),[b,j]=(0,r.useState)("Unknown"),[N,S]=(0,r.useState)(null),[I,k]=(0,r.useState)(""),[E,P]=(0,r.useState)(null),[T,q]=(0,r.useState)(!1),A=(0,r.useRef)(null),[R,O]=(0,r.useState)(!1),[_,C]=(0,r.useState)(null),[M,V]=(0,r.useState)(""),[D,F]=(0,r.useState)(null),[Z,L]=(0,r.useState)(null),[B,G]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(u.length>0&&!N){let e=Math.floor(Math.random()*u.length);S(u[e])}},[u]),(0,r.useEffect)(()=>(E&&T&&!Z&&u.length>0&&!R&&"LIVE"===c&&L(setTimeout(()=>{U()},1e3*Math.floor(91*Math.random()+30))),()=>{Z&&clearTimeout(Z)}),[E,T,u,R]);let U=()=>{if(0===u.length||!E)return;let e=u.filter(e=>E.answers.some(t=>t.questionId===e.id));if(e.length>0){let t=Math.floor(Math.random()*e.length);C(e[t]),O(!0),F(60);let a=setInterval(()=>{F(e=>null===e||e<=1?(clearInterval(a),H(),null):e-1)},1e3)}else L(setTimeout(()=>{U()},6e4))},H=async()=>{G(!0);try{await s.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"Mid-survey validation timeout",metadata:{questionId:null==_?void 0:_.id,timestamp:new Date().toISOString()}})}catch(e){console.error("Error flagging validation timeout:",e)}},J=async()=>{if(!_||!E)return;let e=E.answers.find(e=>e.questionId===_.id);if(e){if(e.value===M)O(!1),L(setTimeout(()=>{U()},1e3*Math.floor(91*Math.random()+30)));else{G(!0);try{await s.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"Mid-survey validation failed",metadata:{questionId:_.id,originalAnswer:e.value,newAnswer:M,timestamp:new Date().toISOString()}})}catch(e){console.error("Error flagging validation failure:",e)}}}};(0,r.useEffect)(()=>{(async()=>{if(t&&a){g(!0);try{let e=await s.Z.get("/api/ip-check"),t=await o(e.data.ip),a=e.data.country||"Unknown";j(a);let i=!l||!l.length||l.includes(a);t&&("LIVE"===c?(y(!0),await s.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"VPN detected",metadata:{ip:e.data.ip,country:a}})):(console.log("VPN detected but allowed in TEST mode"),await s.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"VPN detected (TEST link)",metadata:{ip:e.data.ip,country:a}}))),i||("LIVE"===c?(w(!0),await s.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"Geographic restriction violation",metadata:{ip:e.data.ip,country:a,allowedCountries:l}})):(console.log("Geo-restriction violated but allowed in TEST mode"),await s.Z.post("/api/links/flag",{projectId:m.query.projectId,uid:m.query.uid,reason:"Geographic restriction violation (TEST link)",metadata:{ip:e.data.ip,country:a,allowedCountries:l}})));let r=function(){try{let e={ip:null,userAgent:navigator.userAgent,browser:function(){let e=navigator.userAgent;return e.includes("Firefox")?"Firefox":e.includes("Edg/")?"Edge":e.includes("Chrome")&&!e.includes("Edg/")?"Chrome":!e.includes("Safari")||e.includes("Chrome")||e.includes("Edg/")?e.includes("MSIE")||e.includes("Trident/")?"Internet Explorer":e.includes("Opera")||e.includes("OPR/")?"Opera":e.includes("Brave")?"Brave":null:"Safari"}(),device:function(){let e=navigator.userAgent;return/iPhone|iPod|Android.*Mobile|webOS|BlackBerry|IEMobile|Opera Mini/i.test(e)?"Mobile":/iPad|Android(?!.*Mobile)|Tablet|Silk/i.test(e)?"Tablet":"Desktop"}(),language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timestamp:Date.now(),fingerprint:function(){let e=[navigator.userAgent,navigator.language,Intl.DateTimeFormat().resolvedOptions().timeZone,screen.colorDepth,navigator.cookieEnabled,navigator.hardwareConcurrency||0,"".concat(screen.width,"x").concat(screen.height),navigator.platform||"",navigator.deviceMemory||0,navigator.maxTouchPoints||0],t=0,a=e.join("###");for(let e=0;e<a.length;e++)t=(t<<5)-t+a.charCodeAt(e)|0;return t.toString(16)}(),screen:{width:window.screen.width,height:window.screen.height,colorDepth:window.screen.colorDepth,pixelRatio:window.devicePixelRatio||1},behavioral:{mouseMovements:0,keyboardEvents:0,totalTime:0,clickPattern:[]}};try{try{navigator.plugins&&navigator.plugins.length>0&&(e.plugins=Array.from(navigator.plugins).map(e=>e.name))}catch(e){console.warn("Error collecting plugin data:",e)}try{let t=document.createElement("canvas"),a=t.getContext("2d");a&&(t.width=200,t.height=50,a.textBaseline="top",a.font="14px Arial",a.fillStyle="#f60",a.fillRect(0,0,100,25),a.fillStyle="#069",a.fillText("Browser Fingerprint",2,15),a.fillStyle="rgba(102, 204, 0, 0.7)",a.fillText("Browser Fingerprint",4,17),e.canvas=t.toDataURL())}catch(e){console.warn("Canvas fingerprinting not available:",e)}try{let t=document.createElement("canvas").getContext("webgl");t&&(e.webGL={vendor:t.getParameter(t.VENDOR),renderer:t.getParameter(t.RENDERER)})}catch(e){console.warn("WebGL not available:",e)}}catch(e){console.error("Error collecting advanced fingerprinting data:",e)}return e}catch(a){var e,t;return console.error("Critical error in metadata collection:",a),{ip:null,userAgent:(null===(e=navigator)||void 0===e?void 0:e.userAgent)||null,browser:null,device:null,language:(null===(t=navigator)||void 0===t?void 0:t.language)||null,timezone:null,timestamp:Date.now(),fingerprint:null}}}();if(!f&&!v){let t="".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,15)),i={token:t,projectId:m.query.projectId,uid:m.query.uid,linkType:c,answers:N?[{questionId:N.id,value:I||""}]:[],metadata:{...r,ip:e.data.ip,country:a,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,vendor:d}};sessionStorage.setItem("surveySession",JSON.stringify(i)),P(i);try{await s.Z.post("/api/links/update-status",{projectId:m.query.projectId,uid:m.query.uid,status:"STARTED",token:t,metadata:i.metadata})}catch(e){console.error("Failed to update status to STARTED:",e)}}}catch(e){console.error("Error during security checks:",e),p("Failed to perform security checks. Please try again later.")}finally{g(!1)}}})()},[a,t,l,c,m.query,d]);let z=async()=>{if(!I||!N){p("Please select an answer to continue");return}try{let e=sessionStorage.getItem("surveySession");if(e){let t=JSON.parse(e),a=t.answers.findIndex(e=>e.questionId===N.id);a>=0?t.answers[a].value=I:t.answers.push({questionId:N.id,value:I}),sessionStorage.setItem("surveySession",JSON.stringify(t)),P(t),await s.Z.post("/api/links/update-status",{projectId:m.query.projectId,uid:m.query.uid,status:"IN_PROGRESS",questionId:N.id,answer:I,token:t.token})}S(null)}catch(e){console.error("Error saving answer:",e),p("Failed to save your answer. Please try again.")}};return t?h?(0,i.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,i.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold text-gray-800 mb-4",children:"Loading Survey"}),(0,i.jsx)("p",{className:"text-gray-600 mb-6",children:"Please wait while we set up your survey..."}),(0,i.jsx)("div",{className:"flex justify-center",children:(0,i.jsx)("div",{className:"animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"})})]})}):x?(0,i.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,i.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Error"}),(0,i.jsx)("p",{className:"text-gray-700 mb-6",children:x})]})}):f?(0,i.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,i.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold text-amber-600 mb-4",children:"VPN Detected"}),(0,i.jsx)("p",{className:"text-gray-700 mb-6",children:"It appears you're using a VPN or proxy. To ensure data quality, please disable your VPN and refresh this page."}),(0,i.jsx)("p",{className:"text-gray-500 text-sm",children:"This helps us maintain the integrity of survey responses."})]})}):v?(0,i.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,i.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Geographic Restriction"}),(0,i.jsxs)("p",{className:"text-gray-700 mb-6",children:["We're sorry, but this survey is not available in your country (",b,")."]}),(0,i.jsx)("p",{className:"text-gray-500 text-sm",children:"This survey is only available to participants from specific regions."})]})}):B?(0,i.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,i.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Validation Failed"}),(0,i.jsx)("p",{className:"text-gray-700 mb-6",children:"Your answers were inconsistent with your previous responses. This survey has been marked for review."}),(0,i.jsx)("p",{className:"text-gray-500 text-sm",children:"Consistent answers are important for data quality."})]})}):N?(0,i.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,i.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Pre-Survey Question"}),(0,i.jsx)("p",{className:"text-gray-500 text-sm mb-6",children:"Please answer this question before proceeding to the survey."}),(0,i.jsxs)("div",{className:"mb-6",children:[(0,i.jsx)("h2",{className:"text-lg font-medium text-gray-700 mb-3",children:N.text}),(0,i.jsx)("div",{className:"space-y-2",children:N.options.map((e,t)=>(0,i.jsxs)("div",{className:"flex items-center",children:[(0,i.jsx)("input",{id:"option-".concat(t),type:"radio",name:"question",value:e,className:"h-4 w-4 text-blue-600 focus:ring-blue-500",onChange:()=>k(e),checked:I===e}),(0,i.jsx)("label",{htmlFor:"option-".concat(t),className:"ml-2 block text-gray-700",children:e})]},t))})]}),(0,i.jsx)("button",{onClick:z,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline",children:"Continue to Survey"})]})}):R&&_?(0,i.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,i.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8",children:[(0,i.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold text-amber-600",children:"Verification Required"}),(0,i.jsxs)("div",{className:"text-amber-600 font-semibold",children:[D,"s"]})]}),(0,i.jsx)("p",{className:"text-gray-500 text-sm mb-6",children:"Please answer this question again to verify your identity."}),(0,i.jsxs)("div",{className:"mb-6",children:[(0,i.jsx)("h2",{className:"text-lg font-medium text-gray-700 mb-3",children:_.text}),(0,i.jsx)("div",{className:"space-y-2",children:_.options.map((e,t)=>(0,i.jsxs)("div",{className:"flex items-center",children:[(0,i.jsx)("input",{id:"mid-option-".concat(t),type:"radio",name:"mid-question",value:e,className:"h-4 w-4 text-blue-600 focus:ring-blue-500",onChange:()=>V(e),checked:M===e}),(0,i.jsx)("label",{htmlFor:"mid-option-".concat(t),className:"ml-2 block text-gray-700",children:e})]},t))})]}),(0,i.jsx)("button",{onClick:J,className:"w-full bg-amber-600 hover:bg-amber-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline",disabled:!M,children:"Verify & Continue"})]})}):(0,i.jsxs)("div",{className:"flex flex-col min-h-screen",children:[(0,i.jsx)("header",{className:"bg-white shadow-sm p-4",children:(0,i.jsx)("div",{className:"container mx-auto",children:(0,i.jsx)("h1",{className:"text-lg font-medium text-gray-800",children:"Survey in Progress"})})}),(0,i.jsx)("main",{className:"flex-grow relative",children:a&&(0,i.jsx)("iframe",{ref:A,src:a,className:"w-full h-full absolute top-0 left-0 border-0",onLoad:()=>{q(!0)},title:"Survey"})})]}):(0,i.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4",children:(0,i.jsxs)("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-8 text-center",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Invalid Survey Link"}),(0,i.jsx)("p",{className:"text-gray-700 mb-6",children:"This survey link is invalid or has expired. Please check the URL or contact the survey administrator."})]})})}}},function(e){e.O(0,[143,888,774,179],function(){return e(e.s=4735)}),_N_E=e.O()}]);